image: public.ecr.aws/r3m4q3r9/qovery-ci:base-2023-03-24T13-48-55

services:
  - docker:dind

variables:
  FF_GITLAB_REGISTRY_HELPER_IMAGE: 1
  DOCKER_DRIVER: overlay2
  DOCKER_HOST: tcp://localhost:2375
  DOCKER_BUILDKIT: 1
  DOCKER_TLS_CERTDIR: ""

stages:
  - release
  - deploy

before_script:
  - curl -o helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 && chmod 755 helm.sh && ./helm.sh -v $HELM_VERSION

release-new-image:
  stage: release
  script:
    - sleep 10m # sleep 10 minutes since chart release isn't instant on tags push
  only:
    - tags
  tags:
    - vm-250mcpu-1gmem-0g

build-new-image:
  stage: release
  before_script:
    - ci_helper init_buildkit_builder "${CI_JOB_NAME}" 2 4
    - ci_helper docker_login_public_prod_ecr
  after_script:
    - ci_helper teardown_buildkit_builder "${CI_JOB_NAME}"
  script:
    - eval $(ci_helper print_aws_ctx 'CI_BUILDER')
    - docker buildx build --platform=linux/amd64,linux/arm64 -t public.ecr.aws/r3m4q3r9/pleco:${CI_COMMIT_TAG} --push .
  only:
    - tags
  tags:
    - vm-250mcpu-1gmem-0g

ec2-test-cluster:
  stage: deploy
  script:
    - helm --kubeconfig $KUBECONFIG_EC2_TEST_CLUSTER upgrade --install --wait -n kube-system -f $PLECO_VALUES_EC2 --create-namespace pleco-ec2 charts/pleco
  only:
    - tags
    - schedules
  tags:
    - vm-250mcpu-1gmem-0g

scaleway-test-cluster:
  stage: deploy
  script:
    - helm --kubeconfig $KUBECONFIG_SCW_TEST_CLUSTER upgrade --install --wait -n kube-system -f $PLECO_VALUES_SCALEWAY --create-namespace pleco-scaleway charts/pleco
  only:
    - tags
    - schedules
  tags:
    - vm-250mcpu-1gmem-0g

eks-test-cluster:
  stage: deploy
  script:
    - curl -o /usr/local/bin/aws-iam-authenticator https://s3.us-west-2.amazonaws.com/amazon-eks/1.21.2/2021-07-05/bin/linux/amd64/aws-iam-authenticator && chmod 755 /usr/local/bin/aws-iam-authenticator
    - AWS_ACCESS_KEY_ID=$EKS_AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY=$EKS_AWS_SECRET_ACCESS_KEY AWS_DEFAULT_REGION=$EKS_AWS_DEFAULT_REGION helm --kubeconfig $KUBECONFIG_EKS_TEST_CLUSTER upgrade --install --wait -n kube-system -f $PLECO_VALUES_EKS --create-namespace pleco-eks charts/pleco
  only:
    - tags
    - schedules
  tags:
    - vm-250mcpu-1gmem-0g

aws-sandbox:
  stage: deploy
  script:
    - curl -o /usr/local/bin/aws-iam-authenticator https://s3.us-west-2.amazonaws.com/amazon-eks/1.21.2/2021-07-05/bin/linux/amd64/aws-iam-authenticator && chmod 755 /usr/local/bin/aws-iam-authenticator
    - AWS_ACCESS_KEY_ID=$EKS_AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY=$EKS_AWS_SECRET_ACCESS_KEY AWS_DEFAULT_REGION=$EKS_AWS_DEFAULT_REGION helm --kubeconfig $KUBECONFIG_EKS_TEST_CLUSTER upgrade --install --wait -n kube-system -f $PLECO_VALUES_SANDBOX --create-namespace pleco-sandbox charts/pleco
  only:
    - tags
    - schedules
  tags:
    - vm-250mcpu-1gmem-0g
